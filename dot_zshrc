
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

export TERM="xterm-256color"

export ZSH="$HOME/.oh-my-zsh"

setopt NO_BEEP
unsetopt HIST_BEEP
unsetopt LIST_BEEP

HISTFILE=~/.zsh_history
HISTSIZE=100000
SAVEHIST=100000

setopt SHARE_HISTORY
unsetopt INC_APPEND_HISTORY
unsetopt INC_APPEND_HISTORY_TIME

ZSH_THEME="powerlevel10k/powerlevel10k"
CASE_SENSITIVE="false"
HYPHEN_INSENSITIVE="true"

zstyle ':omz:update' mode reminder  
zstyle ':omz:update' frequency 7

ZSH_AUTOSUGGEST_STRATEGY=(history completion)
plugins=(git zsh-autosuggestions zsh-syntax-highlighting zsh-z)

source $ZSH/oh-my-zsh.sh

[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

export PATH="$HOME/go/bin:$HOME/.local/bin:$PATH"
export IS_SANDBOX=1

export LANG=en_US.UTF-8
export LC_CTYPE=en_US.UTF-8
export LC_ALL=en_US.UTF-8

export AFL_DEBUG=1
export AFL_SKIP_CRASHES=1
export AFL_FAST_CAL=1

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

export PROTOCOL_GUARD_SQLITE_DATABASE=/root/ProtocolGuard-Database/sqlite_uFTPD.db
alias rp='realpath'
alias claude="claude --dangerously-skip-permissions"
alias codex="codex --dangerously-bypass-approvals-and-sandbox"


export OPENAI_BASE_URL="http://192.168.31.236:3001/v1"

export ENABLE_TOOL_SEARCH=true
export ANTHROPIC_BASE_URL="http://192.168.31.236:3001"
alias cmt="claude --model haiku \"commit with your skill\""

[ -s "/root/.bun/_bun" ] && source "/root/.bun/_bun"

export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"
ulimit -c 0

function tmuxfix() {
  printf '\e[?1000l\e[?1002l\e[?1003l\e[?1006l\e[?1015l'
  stty sane
  tmux source-file ~/.tmux.conf >/dev/null 2>&1 || true
}

function code() {
  local vscode_ipc=$(tmux show-env VSCODE_IPC_HOOK_CLI | cut -d '=' -f2) 2>/dev/null
  if [[ -v TMUX && vscode_ipc != "" ]]; then
    VSCODE_IPC_HOOK_CLI=$vscode_ipc command code "$@"
  else
    command code "$@"
  fi
}

function hgrep() {
    if [ -z "$1" ]; then
        echo "Usage: hgrep [search_term]"
        return 1
    fi
    fc -l -n 1 | grep --color=auto -i "$@" | sed 's/\\n/\n/g;G'
}

function apt() {
    local cmd="$1"
    
    if [[ -z "$cmd" ]]; then
        apt-fast
        return
    fi

    case "$cmd" in
        install)
            shift
            sudo apt-fast install -y "$@"
            ;;
        update|upgrade|full-upgrade|dist-upgrade|remove|purge|autoremove|clean|autoclean)
            sudo apt-fast "$@"
            ;;
        *)
            apt-fast "$@"
            ;;
    esac
}

function aria2d() {
    if [ -z "$1" ]; then
        echo "Usage: agd <URL> [filename]"
        return 1
    fi

    local url=$1
    local output=$2
    
    local args=("-s" "16" "-x" "16" "-k" "1M" "--continue=true")

    if [ -n "$output" ]; then
        aria2c "${args[@]}" -o "$output" "$url"
    else
        aria2c "${args[@]}" "$url"
    fi
}

autoload -Uz add-zsh-hook
zmodload -F zsh/stat b:zstat 2>/dev/null

typeset -g _HIST_MTIME=0

_sync_hist_for_autosuggest() {
  [[ -o interactive ]] || return

  local -a st
  if zstat -A st +mtime -- "$HISTFILE" 2>/dev/null; then
    (( st[1] == _HIST_MTIME )) && return
    _HIST_MTIME=$st[1]
  fi

  fc -R 
}

add-zsh-hook precmd _sync_hist_for_autosuggest
