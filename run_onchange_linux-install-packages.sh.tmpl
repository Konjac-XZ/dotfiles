{{- if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -euo pipefail

# ---- Activate Homebrew without relying on .zshrc ----
BREW=""
for b in \
  "$(command -v brew 2>/dev/null || true)" \
  /home/linuxbrew/.linuxbrew/bin/brew \
  "$HOME/.linuxbrew/bin/brew" \
  /opt/homebrew/bin/brew \
  /usr/local/bin/brew
do
  if [ -n "${b:-}" ] && [ -x "$b" ]; then
    BREW="$b"
    break
  fi
done

if [ -z "$BREW" ]; then
  echo "[chezmoi] brew not found (non-interactive run); skipping package install." >&2
  exit 0
fi

# Put brew + its paths into this process environment
eval "$("$BREW" shellenv)"

# Ensure brew bundle exists
if ! brew help bundle >/dev/null 2>&1; then
  brew tap homebrew/bundle
fi

# ---- Install declared packages ----
brew bundle --no-upgrade --file=/dev/stdin <<'EOF'
{{- range .packages.linux.brews }}
brew {{ . | quote }}
{{- end }}
{{- range .packages.linux.casks }}
cask {{ . | quote }}
{{- end }}
EOF
{{- end -}}